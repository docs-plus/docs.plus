#!/bin/sh

echo "ğŸ” Pre-push checks starting..."
echo ""

# Track overall status
FAILED=0

# ============================================
# 1. Type Checks (fast - catches type errors)
# ============================================
echo "ğŸ“ Running TypeScript type checks..."

# Hocuspocus Server
echo "  â†’ hocuspocus.server..."
if cd packages/hocuspocus.server && bun run tsc --noEmit 2>/dev/null; then
    echo "    âœ… hocuspocus.server types OK"
else
    echo "    âŒ hocuspocus.server type errors"
    FAILED=1
fi
cd ../..

# Admin Dashboard (via Next.js)
echo "  â†’ admin-dashboard..."
if cd packages/admin-dashboard && bun run tsc --noEmit 2>/dev/null; then
    echo "    âœ… admin-dashboard types OK"
else
    echo "    âŒ admin-dashboard type errors"
    FAILED=1
fi
cd ../..

# Webapp (via Next.js)
echo "  â†’ webapp..."
if cd packages/webapp && bun run tsc --noEmit 2>/dev/null; then
    echo "    âœ… webapp types OK"
else
    echo "    âŒ webapp type errors"
    FAILED=1
fi
cd ../..

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Type checks failed. Fix type errors before pushing."
    exit 1
fi

echo ""

# ============================================
# 2. Build TipTap Extensions (webapp deps)
# ============================================
echo "ğŸ“¦ Building TipTap extensions..."
for ext in extension-hyperlink extension-hypermultimedia extension-indent extension-inline-code; do
    if bun run --filter "@docs.plus/${ext}" build >/dev/null 2>&1; then
        echo "  âœ… ${ext}"
    else
        echo "  âŒ ${ext} build failed"
        FAILED=1
    fi
done

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Extension builds failed. Push aborted."
    exit 1
fi

echo ""

# ============================================
# 3. Build Next.js Apps (catches all errors)
# ============================================
echo "ğŸ“¦ Building Next.js applications..."

# Admin Dashboard
echo "  â†’ admin-dashboard..."
if bun run --filter "@docs.plus/admin-dashboard" build:local >/dev/null 2>&1; then
    echo "  âœ… admin-dashboard build OK"
else
    echo "  âŒ admin-dashboard build failed"
    FAILED=1
fi

# Webapp
echo "  â†’ webapp..."
if bun run --filter "@docs.plus/webapp" build:local >/dev/null 2>&1; then
    echo "  âœ… webapp build OK"
else
    echo "  âŒ webapp build failed"
    FAILED=1
fi

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Next.js builds failed. Push aborted."
    exit 1
fi

echo ""
echo "ğŸš€ All pre-push checks passed. Proceeding with push."
