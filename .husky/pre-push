#!/bin/sh

echo "ğŸ” Pre-push checks starting..."
echo ""

# Get changed files compared to origin/main (or HEAD~1 if on main)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "")
else
    CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1 2>/dev/null || echo "")
fi

# Track overall status
FAILED=0

# ============================================
# 1. Build TipTap Extensions (only if changed)
# ============================================
EXTENSIONS="extension-hyperlink extension-hypermultimedia extension-indent extension-inline-code"
NEEDS_BUILD=""

for ext in $EXTENSIONS; do
    if echo "$CHANGED_FILES" | grep -q "packages/${ext}/"; then
        NEEDS_BUILD="$NEEDS_BUILD $ext"
    fi
done

if [ -n "$NEEDS_BUILD" ]; then
    echo "ğŸ“¦ Building changed TipTap extensions..."
    for ext in $NEEDS_BUILD; do
        if bun run --filter "@docs.plus/${ext}" build >/dev/null 2>&1; then
            echo "  âœ… ${ext}"
        else
            echo "  âŒ ${ext} build failed"
            FAILED=1
        fi
    done
else
    echo "ğŸ“¦ No extension changes detected, skipping extension builds"
fi

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Extension builds failed. Push aborted."
    exit 1
fi

echo ""

# ============================================
# 2. Build Admin Dashboard (only if changed)
# ============================================
if echo "$CHANGED_FILES" | grep -q "packages/admin-dashboard/"; then
    echo "ğŸ“¦ Building admin-dashboard..."
    # Use direct next build with production mode and minimal env vars
    if cd packages/admin-dashboard && \
       NODE_ENV=production \
       NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321 \
       NEXT_PUBLIC_SUPABASE_ANON_KEY=dummy-key-for-build-check \
       NEXT_PUBLIC_API_URL=http://localhost:3003 \
       NEXT_PUBLIC_APP_URL=http://localhost:3000 \
       npx next build >/dev/null 2>&1; then
        echo "  âœ… admin-dashboard build OK"
        cd ../..
    else
        echo "  âŒ admin-dashboard build failed"
        cd ../..
        FAILED=1
    fi
else
    echo "ğŸ“¦ No admin-dashboard changes detected, skipping build"
fi

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Admin dashboard build failed. Push aborted."
    exit 1
fi

echo ""

# ============================================
# 3. Build Webapp (only if changed)
# ============================================
if echo "$CHANGED_FILES" | grep -q "packages/webapp/"; then
    echo "ğŸ“¦ Building webapp..."
    # Use direct next build with production mode and minimal env vars
    # (matches CI pr-check workflow - just validates build, not real deployment)
    if cd packages/webapp && \
       NODE_ENV=production \
       NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321 \
       NEXT_PUBLIC_SUPABASE_ANON_KEY=dummy-key-for-build-check \
       npx next build >/dev/null 2>&1; then
        echo "  âœ… webapp build OK"
        cd ../..
    else
        echo "  âŒ webapp build failed"
        cd ../..
        FAILED=1
    fi
else
    echo "ğŸ“¦ No webapp changes detected, skipping build"
fi

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "âŒ Webapp build failed. Push aborted."
    exit 1
fi

echo ""
echo "ğŸš€ All pre-push checks passed. Proceeding with push."
