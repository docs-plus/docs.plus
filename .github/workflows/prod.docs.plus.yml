# ============================================================================
# Production CI/CD Pipeline - Blue-Green Zero Downtime Deployment
# ============================================================================
#
# DIRECTORY STRUCTURE ON SERVER:
# /opt/projects/prod.docs.plus/
# ‚îú‚îÄ‚îÄ .env                              ‚Üê Main environment file (you edit this)
# ‚îî‚îÄ‚îÄ app/docs.plus/docs.plus/          ‚Üê Git repo (GitHub Actions workspace)
#
# ============================================================================

name: CI-Production-BlueGreen

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ENV_SOURCE: /opt/projects/prod.docs.plus/.env
  ENV_FILE: .env.production
  COMPOSE_FILE: docker-compose.prod.yml
  DOCKER_NETWORK: prod-docsplus-network
  FRONTEND_PORT_BLUE: 3001
  FRONTEND_PORT_GREEN: 3011

jobs:
  deploy-stack:
    name: üöÄ Deploy Full Stack (Blue-Green)
    runs-on: prod.docs.plus
    if: contains(github.event.head_commit.message, 'build') && (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back'))

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: false

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì• Install Dependencies
        run: bun install --frozen-lockfile

      - name: üîê Prepare Environment
        run: |
          echo "üìÅ Current directory: $(pwd)"
          echo "üìÅ .env source: ${{ env.ENV_SOURCE }}"
          if [ ! -f "${{ env.ENV_SOURCE }}" ]; then
            echo "‚ùå .env file not found at ${{ env.ENV_SOURCE }}"
            exit 1
          fi
          cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"
          if ! grep -q "DATABASE_URL" "${{ env.ENV_FILE }}"; then
            echo "‚ùå DATABASE_URL not found in .env file"
            exit 1
          fi
          echo "‚úÖ Environment prepared"

      - name: üîç Detect Current Deployment Color
        id: detect-color
        run: |
          if docker ps --format '{{.Names}}' | grep -q "^prod-blue-"; then
            echo "CURRENT_COLOR=blue" >> $GITHUB_OUTPUT
            echo "NEW_COLOR=green" >> $GITHUB_OUTPUT
            echo "CURRENT_PORT=${{ env.FRONTEND_PORT_BLUE }}" >> $GITHUB_OUTPUT
            echo "NEW_PORT=${{ env.FRONTEND_PORT_GREEN }}" >> $GITHUB_OUTPUT
            echo "üìò Current: BLUE ‚Üí Deploying: GREEN üü¢"
          elif docker ps --format '{{.Names}}' | grep -q "^prod-green-"; then
            echo "CURRENT_COLOR=green" >> $GITHUB_OUTPUT
            echo "NEW_COLOR=blue" >> $GITHUB_OUTPUT
            echo "CURRENT_PORT=${{ env.FRONTEND_PORT_GREEN }}" >> $GITHUB_OUTPUT
            echo "NEW_PORT=${{ env.FRONTEND_PORT_BLUE }}" >> $GITHUB_OUTPUT
            echo "üü¢ Current: GREEN ‚Üí Deploying: BLUE üìò"
          else
            echo "CURRENT_COLOR=none" >> $GITHUB_OUTPUT
            echo "NEW_COLOR=blue" >> $GITHUB_OUTPUT
            echo "CURRENT_PORT=none" >> $GITHUB_OUTPUT
            echo "NEW_PORT=${{ env.FRONTEND_PORT_BLUE }}" >> $GITHUB_OUTPUT
            echo "üÜï First deployment: BLUE üìò"
          fi

      - name: üîç Ensure Redis is Running
        run: |
          docker network create ${{ env.DOCKER_NETWORK }} 2>/dev/null || true
          if docker ps -a --format '{{.Names}}' | grep -q "^prod-docsplus-redis$"; then
            if ! docker ps --format '{{.Names}}' | grep -q "^prod-docsplus-redis$"; then
              echo "üîÑ Starting existing Redis container..."
              docker start prod-docsplus-redis
              sleep 3
            fi
            docker network connect ${{ env.DOCKER_NETWORK }} prod-docsplus-redis 2>/dev/null || true
          else
            if ss -tuln 2>/dev/null | grep -q ":6379 "; then
              echo "‚ö†Ô∏è Port 6379 already in use"
              if redis-cli ping 2>/dev/null | grep -q PONG; then
                echo "‚úÖ Existing Redis on port 6379 is healthy"
                exit 0
              else
                echo "‚ùå Port 6379 in use but not Redis"
                exit 1
              fi
            fi
            echo "üöÄ Starting new Redis container..."
            docker run -d \
              --name prod-docsplus-redis \
              --network ${{ env.DOCKER_NETWORK }} \
              --restart unless-stopped \
              -p 6379:6379 \
              -v prod-redis-data:/data \
              redis:alpine \
              redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy noeviction
            sleep 5
          fi
          if docker exec prod-docsplus-redis redis-cli ping 2>/dev/null | grep -q PONG; then
            echo "‚úÖ Redis healthy (container)"
          elif redis-cli ping 2>/dev/null | grep -q PONG; then
            echo "‚úÖ Redis healthy (host)"
          else
            echo "‚ùå Redis health check failed"
            exit 1
          fi

      - name: üèóÔ∏è Build Docker Images
        run: |
          echo "üî® Building ${{ steps.detect-color.outputs.NEW_COLOR }} stack..."
          export DATABASE_URL=$(grep "^DATABASE_URL=" ${{ env.ENV_FILE }} | cut -d'=' -f2-)
          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            -p prod-${{ steps.detect-color.outputs.NEW_COLOR }} \
            build \
            --build-arg DATABASE_URL="${DATABASE_URL}"
          echo "‚úÖ Images built"

      - name: üöÄ Deploy New Stack
        run: |
          sed -i "s/NGINX_HTTP_PORT=.*/NGINX_HTTP_PORT=${{ steps.detect-color.outputs.NEW_PORT }}/" ${{ env.ENV_FILE }}
          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            -p prod-${{ steps.detect-color.outputs.NEW_COLOR }} \
            up -d \
            --scale webapp=2 \
            --scale rest-api=2 \
            --scale hocuspocus-server=2 \
            --scale hocuspocus-worker=1
          echo "‚úÖ Stack deployed"

      - name: ‚è≥ Wait for Services
        run: sleep 30

      - name: ü©∫ Health Check - Frontend
        run: |
          WEBAPP=$(docker ps --filter "name=prod-${{ steps.detect-color.outputs.NEW_COLOR }}-webapp" --format "{{.Names}}" | head -1)
          if [ -z "$WEBAPP" ]; then
            echo "‚ùå No webapp container found"
            exit 1
          fi
          for i in {1..30}; do
            if docker exec $WEBAPP bun -e "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" &> /dev/null; then
              echo "‚úÖ Frontend healthy"
              exit 0
            fi
            echo "‚è≥ Attempt $i/30..."
            sleep 2
          done
          echo "‚ùå Frontend health check failed"
          docker logs $WEBAPP --tail 100
          exit 1

      - name: ü©∫ Health Check - Backend
        run: |
          REST=$(docker ps --filter "name=prod-${{ steps.detect-color.outputs.NEW_COLOR }}-rest-api" --format "{{.Names}}" | head -1)
          docker exec $REST bun -e "fetch('http://localhost:4000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "‚úÖ REST API healthy" || (docker logs $REST --tail 50 && exit 1)
          WS=$(docker ps --filter "name=prod-${{ steps.detect-color.outputs.NEW_COLOR }}-hocuspocus-server" --format "{{.Names}}" | head -1)
          docker exec $WS bun -e "fetch('http://localhost:4001/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "‚úÖ WebSocket healthy" || (docker logs $WS --tail 50 && exit 1)
          WORKER=$(docker ps --filter "name=prod-${{ steps.detect-color.outputs.NEW_COLOR }}-hocuspocus-worker" --format "{{.Names}}" | head -1)
          docker exec $WORKER bun -e "fetch('http://localhost:4002/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "‚úÖ Worker healthy" || (docker logs $WORKER --tail 50 && exit 1)

      - name: üîÑ Update Nginx
        run: |
          sudo cp /etc/nginx/sites-available/docs.plus /etc/nginx/sites-available/docs.plus.backup.$(date +%Y%m%d_%H%M%S)
          sudo sed -i "s/server localhost:[0-9]\+;/server localhost:${{ steps.detect-color.outputs.NEW_PORT }};/" /etc/nginx/sites-available/docs.plus
          sudo nginx -t && sudo nginx -s reload
          echo "‚úÖ Nginx updated to port ${{ steps.detect-color.outputs.NEW_PORT }}"

      - name: ‚è≥ Grace Period
        run: sleep 15

      - name: üõë Remove Old Stack
        if: steps.detect-color.outputs.CURRENT_COLOR != 'none'
        run: |
          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            -p prod-${{ steps.detect-color.outputs.CURRENT_COLOR }} \
            down
          echo "‚úÖ Old stack (${{ steps.detect-color.outputs.CURRENT_COLOR }}) removed"

      - name: üßπ Cleanup
        run: |
          docker image prune -f
          docker volume prune -f --filter "label!=keep"

      - name: üìä Summary
        run: |
          echo "======================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "======================================"
          echo "Stack: prod-${{ steps.detect-color.outputs.NEW_COLOR }}"
          echo "Port: ${{ steps.detect-color.outputs.NEW_PORT }}"
          docker ps --filter "name=prod-${{ steps.detect-color.outputs.NEW_COLOR }}-" --format "table {{.Names}}\t{{.Status}}"
          echo "URLs: https://docs.plus | https://prodback.docs.plus"
          echo "======================================"

  deploy-uptime-kuma:
    name: üîî Deploy Uptime Kuma
    runs-on: prod.docs.plus
    if: contains(github.event.head_commit.message, 'build') && contains(github.event.head_commit.message, 'uptime-kuma')

    steps:
      - name: üöÄ Deploy
        run: |
          docker network create ${{ env.DOCKER_NETWORK }} 2>/dev/null || true
          docker stop uptime-kuma 2>/dev/null || true
          docker rm uptime-kuma 2>/dev/null || true
          docker run -d \
            --name uptime-kuma \
            --network ${{ env.DOCKER_NETWORK }} \
            --restart unless-stopped \
            -p 3001:3001 \
            -v uptime-kuma-data:/app/data \
            louislam/uptime-kuma:latest
          sleep 15
          curl -f -s http://localhost:3001 > /dev/null && echo "‚úÖ Uptime Kuma running" || echo "‚ö†Ô∏è May need more time"
