# ============================================================================
# Production CI/CD Pipeline - Traefik Zero-Downtime Deployment
# ============================================================================
#
# Architecture:
#   Traefik (SSL/LB) â†’ Services (auto-discovered via Docker labels)
#
# Deployment Strategy:
#   Rolling update - Traefik handles graceful traffic shifting
#   New containers start â†’ health check passes â†’ old containers removed
#
# ============================================================================

name: CI-Production

on:
 push:
  branches: [main]
 pull_request:
  branches: [main]

env:
 ENV_SOURCE: /opt/projects/prod.docs.plus/.env
 ENV_FILE: .env.production
 COMPOSE_FILE: docker-compose.prod.yml
 DEPLOY_TAG: ${{ github.sha }}

jobs:
 deploy:
  name: ðŸš€ Deploy to Production
  runs-on: prod.docs.plus
  if: contains(github.event.head_commit.message, 'build') && (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back'))

  steps:
   - name: ðŸ“¦ Checkout Code
     uses: actions/checkout@v4
     with:
      fetch-depth: 1

   - name: ðŸ¥Ÿ Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: latest

   - name: ðŸ“¥ Install Dependencies
     run: bun install --frozen-lockfile

   - name: ðŸ” Prepare Environment
     run: |
      echo "ðŸ“ Copying environment file..."
      if [ ! -f "${{ env.ENV_SOURCE }}" ]; then
        echo "âŒ .env file not found at ${{ env.ENV_SOURCE }}"
        exit 1
      fi
      cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"

      # Add deploy tag
      echo "DEPLOY_TAG=${{ env.DEPLOY_TAG }}" >> "${{ env.ENV_FILE }}"

      # Validate required vars
      for var in DATABASE_URL SUPABASE_URL SUPABASE_ANON_KEY; do
        if ! grep -q "^${var}=" "${{ env.ENV_FILE }}"; then
          echo "âŒ ${var} not found in .env"
          exit 1
        fi
      done
      echo "âœ… Environment prepared"

   - name: ðŸ—ï¸ Build Docker Images
     run: |
      echo "ðŸ”¨ Building images with tag: ${{ env.DEPLOY_TAG }}"

      # Load env vars for build args
      set -a
      source ${{ env.ENV_FILE }}
      set +a

      docker-compose -f ${{ env.COMPOSE_FILE }} \
        --env-file ${{ env.ENV_FILE }} \
        build --parallel

      echo "âœ… Images built"

   - name: ðŸš€ Deploy Services (Zero-Downtime Rolling Update)
     run: |
      echo "ðŸš€ Starting zero-downtime deployment..."
      
      # Function to deploy a service with rolling update
      deploy_service() {
        local SERVICE=$1
        local REPLICAS=$2
        
        echo "ðŸ“¦ Deploying $SERVICE..."
        
        # Get current container IDs before deployment
        OLD_CONTAINERS=$(docker ps -q --filter "name=docsplus-${SERVICE}" 2>/dev/null || true)
        
        # Scale up to double (old + new containers)
        DOUBLE=$((REPLICAS * 2))
        docker-compose -f ${{ env.COMPOSE_FILE }} \
          --env-file ${{ env.ENV_FILE }} \
          up -d --no-recreate --scale ${SERVICE}=${DOUBLE} ${SERVICE} 2>/dev/null || \
        docker-compose -f ${{ env.COMPOSE_FILE }} \
          --env-file ${{ env.ENV_FILE }} \
          up -d --scale ${SERVICE}=${DOUBLE} ${SERVICE}
        
        # Wait for new containers to be healthy
        echo "â³ Waiting for new ${SERVICE} containers to be healthy..."
        for i in {1..60}; do
          HEALTHY=$(docker ps --filter "name=docsplus-${SERVICE}" --filter "health=healthy" --format "{{.Names}}" | wc -l)
          if [ "$HEALTHY" -ge "$REPLICAS" ]; then
            echo "âœ… ${SERVICE}: ${HEALTHY} healthy containers"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âš ï¸ ${SERVICE} health check timeout, continuing..."
          fi
          sleep 2
        done
        
        # Scale back to target (removes oldest containers)
        docker-compose -f ${{ env.COMPOSE_FILE }} \
          --env-file ${{ env.ENV_FILE }} \
          up -d --scale ${SERVICE}=${REPLICAS} ${SERVICE}
        
        echo "âœ… ${SERVICE} deployed with ${REPLICAS} replicas"
      }
      
      # Ensure network exists
      docker network create docsplus-network 2>/dev/null || true
      
      # Deploy infrastructure first (Traefik + Redis)
      echo "ðŸ”§ Deploying infrastructure..."
      docker-compose -f ${{ env.COMPOSE_FILE }} \
        --env-file ${{ env.ENV_FILE }} \
        up -d traefik redis
      
      # Wait for Traefik to be ready
      sleep 10
      
      # Deploy each service with rolling update
      deploy_service "rest-api" 2
      deploy_service "hocuspocus-server" 2
      deploy_service "hocuspocus-worker" 1
      deploy_service "webapp" 2
      
      # Cleanup orphaned containers
      docker-compose -f ${{ env.COMPOSE_FILE }} \
        --env-file ${{ env.ENV_FILE }} \
        up -d --remove-orphans
      
      echo "âœ… All services deployed with zero-downtime"

   - name: â³ Wait for Health Checks
     run: |
      echo "â³ Waiting for services to be healthy..."
      sleep 30

      # Check Traefik
      if ! docker ps --filter "name=traefik" --filter "health=healthy" | grep -q traefik; then
        echo "âš ï¸ Traefik not healthy yet, waiting..."
        sleep 15
      fi

      echo "âœ… Initial wait complete"

   - name: ðŸ©º Verify Deployment
     run: |
      echo "ðŸ©º Verifying deployment..."

      # Check all services are running
      SERVICES="traefik docsplus-redis"
      for svc in $SERVICES; do
        if ! docker ps --filter "name=$svc" | grep -q "$svc"; then
          echo "âŒ $svc is not running"
          docker logs $svc --tail 50 2>/dev/null || true
          exit 1
        fi
      done

      # Check scaled services
      for svc in webapp rest-api hocuspocus-server hocuspocus-worker; do
        COUNT=$(docker ps --filter "name=${svc}" --format "{{.Names}}" | wc -l)
        if [ "$COUNT" -eq 0 ]; then
          echo "âŒ No $svc containers running"
          exit 1
        fi
        echo "âœ… $svc: $COUNT container(s) running"
      done

      # Health check via Traefik
      echo "ðŸ” Testing endpoints via Traefik..."

      # Wait for SSL cert (first deploy might take a moment)
      for i in {1..30}; do
        if curl -sf -o /dev/null https://docs.plus/api/health 2>/dev/null; then
          echo "âœ… docs.plus is healthy"
          break
        fi
        if [ $i -eq 30 ]; then
          echo "âš ï¸ docs.plus health check timed out (may still be provisioning SSL)"
        fi
        sleep 5
      done

      echo "âœ… Deployment verified"

   - name: ðŸ§¹ Cleanup
     run: |
      # Remove old images
      docker image prune -f --filter "until=24h"

      # Remove unused volumes (careful!)
      docker volume prune -f --filter "label!=keep"

      echo "âœ… Cleanup complete"

   - name: ðŸ“Š Summary
     run: |
      echo "======================================"
      echo "âœ… DEPLOYMENT SUCCESSFUL"
      echo "======================================"
      echo "Tag: ${{ env.DEPLOY_TAG }}"
      echo ""
      echo "Services:"
      docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -20
      echo ""
      echo "URLs:"
      echo "  - https://docs.plus"
      echo "  - https://prodback.docs.plus"
      echo "======================================"

   - name: ðŸš¨ Rollback on Failure
     if: failure()
     run: |
      echo "âš ï¸ Deployment failed - attempting rollback..."

      # Get previous working tag (if any)
      PREV_TAG=$(docker images docsy-webapp --format "{{.Tag}}" | grep -v "${{ env.DEPLOY_TAG }}" | head -1)

      if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "latest" ]; then
        echo "ðŸ”„ Rolling back to: $PREV_TAG"
        sed -i "s/DEPLOY_TAG=.*/DEPLOY_TAG=$PREV_TAG/" "${{ env.ENV_FILE }}"
        docker-compose -f ${{ env.COMPOSE_FILE }} \
          --env-file ${{ env.ENV_FILE }} \
          up -d --remove-orphans
        echo "âœ… Rollback complete"
      else
        echo "âš ï¸ No previous version to rollback to"
      fi

 # ===========================================================================
 # UPTIME KUMA (Monitoring)
 # ===========================================================================
 deploy-uptime-kuma:
  name: ðŸ”” Deploy Uptime Kuma
  runs-on: prod.docs.plus
  if: contains(github.event.head_commit.message, 'build') && contains(github.event.head_commit.message, 'uptime-kuma')

  steps:
   - name: ðŸš€ Deploy
     run: |
      docker network create docsplus-network 2>/dev/null || true

      docker stop uptime-kuma 2>/dev/null || true
      docker rm uptime-kuma 2>/dev/null || true

      docker run -d \
        --name uptime-kuma \
        --network docsplus-network \
        --restart unless-stopped \
        -v uptime-kuma-data:/app/data \
        --label "traefik.enable=true" \
        --label "traefik.http.routers.uptime.rule=Host(\`status.docs.plus\`)" \
        --label "traefik.http.routers.uptime.entrypoints=websecure" \
        --label "traefik.http.routers.uptime.tls.certresolver=letsencrypt" \
        --label "traefik.http.services.uptime.loadbalancer.server.port=3001" \
        louislam/uptime-kuma:latest

      sleep 15
      echo "âœ… Uptime Kuma deployed at https://status.docs.plus"
