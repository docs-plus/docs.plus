# Production CI/CD Pipeline for docs.plus
name: CI-Production

# Triggered on push or pull request to main branch
on:
 push:
  branches: [main]
 pull_request:
  branches: [main]

jobs:
 # ============================================================
 # UPTIME KUMA - Independent pipeline (no dependencies)
 # ============================================================
 build-uptime-kuma:
  name: ğŸ”” Deploy Uptime Kuma
  runs-on: prod.docs.plus
  if: contains(github.event.head_commit.message, 'build') && contains(github.event.head_commit.message, 'uptime-kuma')
  steps:
   - name: ğŸ“¦ Checkout code
     uses: actions/checkout@v4
     with:
      fetch-depth: 1
      clean: false

   - name: ğŸš€ Deploy Uptime Kuma
     run: make build_uptime_kuma

 # ============================================================
 # SETUP - Shared setup for front/back builds
 # ============================================================
 setup:
  name: âš™ï¸ Setup & Build Extensions
  runs-on: prod.docs.plus
  if: |
   contains(github.event.head_commit.message, 'build') &&
   !contains(github.event.head_commit.message, 'uptime-kuma') &&
   (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back'))
  steps:
   - name: ğŸ“¦ Checkout code
     uses: actions/checkout@v4
     with:
      fetch-depth: 1
      clean: false

   - name: ğŸ¥Ÿ Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: latest

   - name: ğŸ“¥ Install dependencies
     run: bun install --frozen-lockfile

   - name: ğŸ” Preserve .env files
     run: |
      # Copy .env to packages if it exists in the parent directories
      if [ -f "../../../.env" ]; then
        cp ../../../.env packages/webapp/.env
        cp ../../../.env packages/hocuspocus.server/.env
        echo "âœ… .env files copied from ../../../.env"
      elif [ -f "../../.env" ]; then
        cp ../../.env packages/webapp/.env
        cp ../../.env packages/hocuspocus.server/.env
        echo "âœ… .env files copied from ../../.env"
      elif [ -f ".env" ]; then
        cp .env packages/webapp/.env
        cp .env packages/hocuspocus.server/.env
        echo "âœ… .env files copied from root"
      else
        echo "âš ï¸  Warning: No .env file found, using environment variables"
      fi

   - name: ğŸ—ï¸ Build extension packages
     run: bun run build
     env:
      DATABASE_URL: ${{ secrets.STAGE_DATABASE_URL }}

 # ============================================================
 # FRONTEND - Build and deploy Next.js app with PM2
 # ============================================================
 build-front:
  name: ğŸ¨ Deploy Frontend
  needs: setup
  runs-on: prod.docs.plus
  if: contains(github.event.head_commit.message, 'build') && contains(github.event.head_commit.message, 'front')
  steps:
   - name: ğŸš€ Build & Deploy Frontend
     run: make build_front_production

   - name: ğŸ©º Health check
     run: |
      echo "â³ Waiting for app to be ready..."
      sleep 15
      curl -f http://localhost:3001/api/health || (echo "âŒ Health check failed" && exit 1)
      echo "âœ… Frontend is healthy!"

 # ============================================================
 # BACKEND - Build and deploy Hocuspocus server with Docker
 # ============================================================
 build-back:
  name: ğŸ”§ Deploy Backend
  needs: setup
  runs-on: prod.docs.plus
  if: contains(github.event.head_commit.message, 'build') && contains(github.event.head_commit.message, 'back')
  steps:
   - name: ğŸ” Ensure .env is available
     run: |
      if [ -f "../../../.env" ]; then
        cp ../../../.env packages/hocuspocus.server/.env
      elif [ -f "../../.env" ]; then
        cp ../../.env packages/hocuspocus.server/.env
      elif [ -f ".env" ]; then
        cp .env packages/hocuspocus.server/.env
      fi
     continue-on-error: true

   - name: ğŸ³ Build & Deploy Backend
     run: make build_hocuspocus.server_prod
     env:
      DATABASE_URL: ${{ secrets.STAGE_DATABASE_URL }}

   - name: ğŸ“Š Check containers
     run: |
      echo "ğŸ” Checking running containers..."
      docker ps | grep prod-docsplus || echo "âš ï¸  Warning: No prod-docsplus containers found"
      echo "âœ… Backend deployment completed!"

# ============================================================
# ğŸ“– USAGE EXAMPLES
# ============================================================
#
# Trigger specific pipelines by including keywords in commit messages:
#
# 1ï¸âƒ£  Frontend only:
#    git commit -m "Feature: New UI component (build front)"
#
# 2ï¸âƒ£  Backend only:
#    git commit -m "Fix: WebSocket connection (build back)"
#
# 3ï¸âƒ£  Uptime Kuma only:
#    git commit -m "Update monitoring (build uptime-kuma)"
#
# 4ï¸âƒ£  Frontend + Backend:
#    git commit -m "Full deploy (build front back)"
#
# 5ï¸âƒ£  Everything at once:
#    git commit -m "Major release (build front back uptime-kuma)"
#
# Then push to main:
#    git push origin main
#
# ============================================================
# ğŸ” PIPELINE LOGIC
# ============================================================
#
# - Uptime Kuma: Runs independently (no setup needed)
# - Frontend/Backend: Share "setup" job to build extensions
# - All use Bun.js for package management
# - .env files are preserved during deployment
# - Health checks ensure successful deployments
#
# ============================================================
