# ============================================================================
# Production CI/CD Pipeline - Unified Quality Gates + Deployment
# ============================================================================
#
# Pipeline Stages:
#   1. Quality Gates (parallel): lint, typecheck, security
#   2. Build Verification: extensions + apps
#   3. Deploy: Docker build + Blue-Green rolling deployment
#
# Triggers:
#   - Push to main: Full pipeline (deploy requires 'build' in commit)
#   - Pull request to main: Quality gates + build only
#   - Weekly schedule: Security audit only
#
# Architecture:
#   Traefik (SSL/LB) â†’ Services (auto-discovered via Docker labels)
#
# Deployment Strategy:
#   Blue-Green rolling: New containers start â†’ health check â†’ old removed
#
# ============================================================================

name: CI/CD Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly security scan (Sunday midnight UTC)
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      skip_quality_gates:
        description: 'Skip quality gates (emergency deploy)'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment (bypass commit message check)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege - only request needed permissions
permissions:
  contents: read
  actions: read
  security-events: write # For security scan results

env:
  ENV_SOURCE: /opt/projects/prod.docs.plus/.env
  ENV_FILE: .env.production
  COMPOSE_FILE: docker-compose.prod.yml
  DEPLOY_TAG: ${{ github.sha }}

# ============================================================================
# STAGE 1: QUALITY GATES (parallel, fast feedback)
# ============================================================================
jobs:
  lint:
    name: ðŸ” Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name != 'schedule'

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Environment
        uses: ./.github/actions/setup-bun

      - name: ðŸ” ESLint
        run: bun run lint

      - name: ðŸŽ¨ Prettier Check
        run: bun run format:check

  typecheck:
    name: ðŸ“ Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name != 'schedule'

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Environment
        uses: ./.github/actions/setup-bun

      - name: ðŸ”§ Build Extensions (required for types)
        run: |
          bun run --filter @docs.plus/extension-hyperlink build
          bun run --filter @docs.plus/extension-hypermultimedia build
          bun run --filter @docs.plus/extension-indent build
          bun run --filter @docs.plus/extension-inline-code build

      - name: ðŸ“ Type Check All
        run: bun run check:types

  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Environment
        uses: ./.github/actions/setup-bun
        with:
          ignore-scripts: 'true'

      - name: ðŸ” Bun Audit
        run: |
          echo "ðŸ” Checking for known vulnerabilities..."
          bun pm audit 2>&1 | tee audit-results.txt || AUDIT_FAILED=true

          # Count vulnerabilities
          CRITICAL=$(grep -ci "critical" audit-results.txt 2>/dev/null || echo "0")
          HIGH=$(grep -ci "high" audit-results.txt 2>/dev/null || echo "0")

          echo ""
          echo "ðŸ“Š Summary: Critical=$CRITICAL, High=$HIGH"

          # Fail on critical/high
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical/High vulnerabilities found!"
            exit 1
          fi
          echo "âœ… No critical/high vulnerabilities"

      - name: ðŸ“¤ Upload Audit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-${{ github.sha }}
          path: audit-results.txt
          retention-days: 30

  # ============================================================================
  # STAGE 2: BUILD VERIFICATION
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, typecheck, security]
    if: |
      always() &&
      github.event_name != 'schedule' &&
      (needs.lint.result == 'success' || inputs.skip_quality_gates == true) &&
      (needs.typecheck.result == 'success' || inputs.skip_quality_gates == true) &&
      (needs.security.result == 'success' || needs.security.result == 'skipped' || inputs.skip_quality_gates == true)
    outputs:
      build_status: ${{ steps.build_result.outputs.status }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Environment
        uses: ./.github/actions/setup-bun

      - name: ðŸ”§ Build TipTap Extensions
        run: |
          bun run --filter @docs.plus/extension-hyperlink build
          bun run --filter @docs.plus/extension-hypermultimedia build
          bun run --filter @docs.plus/extension-indent build
          bun run --filter @docs.plus/extension-inline-code build

      - name: ðŸ—ï¸ Build Webapp
        run: bun run --filter @docs.plus/webapp build:ci
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'http://localhost:54321' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}

      - name: ðŸ—ï¸ Build Admin Dashboard
        run: bun run --filter @docs.plus/admin-dashboard build:ci
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'http://localhost:54321' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3003' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}

      - name: ðŸ“Š Set Build Result
        id: build_result
        if: always()
        run: echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

  # ============================================================================
  # STAGE 3: PRODUCTION DEPLOYMENT
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy Production
    runs-on: prod.docs.plus
    timeout-minutes: 30
    needs: [build]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.build.result == 'success' &&
      (
        (contains(github.event.head_commit.message, 'build') &&
         (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back')))
        || github.event.inputs.force_deploy == 'true'
      )
    environment:
      name: production
      url: https://docs.plus

    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile --ignore-scripts

      - name: ðŸ” Prepare Environment
        run: |
          cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"
          echo "DEPLOY_TAG=${{ env.DEPLOY_TAG }}" >> "${{ env.ENV_FILE }}"
          echo "âœ… Environment ready"

      - name: ðŸ—ï¸ Build Docker Images
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
        run: |
          echo "ðŸ”¨ Building images with tag: ${{ env.DEPLOY_TAG }}"

          set -a
          source ${{ env.ENV_FILE }}
          set +a

          # Build with parallel execution
          docker compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            build --parallel

          echo "âœ… Images built"

      - name: ðŸ”§ Ensure Infrastructure
        run: |
          echo "ðŸ”§ Ensuring infrastructure..."

          docker network create docsplus-network 2>/dev/null || true

          # Start Traefik and Redis (--no-recreate prevents restart)
          docker compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            up -d --no-recreate traefik redis

          # Check Traefik
          if ! docker ps --filter "name=traefik" --filter "status=running" | grep -q traefik; then
            echo "âš ï¸ Traefik not running, starting..."
            docker compose -f ${{ env.COMPOSE_FILE }} \
              --env-file ${{ env.ENV_FILE }} \
              up -d traefik
            sleep 15
          fi

          # Wait for healthy
          echo "â³ Waiting for Traefik..."
          for i in {1..30}; do
            if docker ps --filter "name=traefik" --filter "health=healthy" | grep -q traefik; then
              echo "âœ… Traefik healthy"
              break
            fi
            [ $i -eq 30 ] && echo "âš ï¸ Traefik health timeout, continuing..."
            sleep 2
          done

      - name: ðŸš€ Deploy Services (Blue-Green)
        run: |
          echo "ðŸš€ Starting zero-downtime deployment..."

          deploy_service() {
            local SERVICE=$1
            local TARGET=$2
            local CURRENT=$(docker ps --filter "label=com.docker.compose.service=${SERVICE}" -q | wc -l | tr -d ' ')
            local SCALE_UP=$((CURRENT + TARGET))

            echo ""
            echo "ðŸ“¦ Deploying $SERVICE (current: $CURRENT, target: $TARGET)..."

            # Scale UP first (keeps old containers)
            if [ "$SCALE_UP" -gt "$CURRENT" ]; then
              echo "â¬†ï¸  Scaling up to $SCALE_UP..."
              docker compose -f ${{ env.COMPOSE_FILE }} \
                --env-file ${{ env.ENV_FILE }} \
                up -d --no-deps --scale ${SERVICE}=${SCALE_UP} ${SERVICE}

              # Wait for healthy
              echo "â³ Waiting for healthy containers..."
              for i in {1..30}; do
                HEALTHY=$(docker ps --filter "label=com.docker.compose.service=${SERVICE}" --filter "health=healthy" -q | wc -l)
                if [ "$HEALTHY" -ge "$TARGET" ]; then
                  echo "âœ… $HEALTHY healthy containers"
                  break
                fi
                [ $((i % 5)) -eq 0 ] && echo "   ... $HEALTHY/$TARGET healthy (attempt $i/30)"
                sleep 2
              done
            fi

            # Scale to target (removes old containers)
            echo "ðŸ“ Scaling to target: $TARGET..."
            docker compose -f ${{ env.COMPOSE_FILE }} \
              --env-file ${{ env.ENV_FILE }} \
              up -d --no-deps --scale ${SERVICE}=${TARGET} ${SERVICE}

            sleep 2
          }

          # Deploy all services
          deploy_service "webapp" 2
          deploy_service "rest-api" 2
          deploy_service "hocuspocus-server" 2
          deploy_service "hocuspocus-worker" 1
          deploy_service "admin-dashboard" 1

          echo ""
          echo "âœ… All services deployed"

      - name: ðŸ©º Verify Deployment
        run: |
          echo "ðŸ©º Verifying deployment..."
          sleep 10

          # Check infrastructure
          echo "ðŸ“Š Infrastructure:"
          for svc in traefik docsplus-redis; do
            if docker ps --filter "name=$svc" --filter "status=running" | grep -q "$svc"; then
              echo "  âœ… $svc: running"
            else
              echo "  âŒ $svc: NOT running"
              docker logs $svc --tail 30 2>/dev/null || true
              exit 1
            fi
          done

          # Check services
          echo "ðŸ“Š Services:"
          for svc in webapp rest-api hocuspocus-server hocuspocus-worker admin-dashboard; do
            RUNNING=$(docker ps --filter "label=com.docker.compose.service=${svc}" --filter "status=running" --format "{{.Names}}" | wc -l)
            HEALTHY=$(docker ps --filter "label=com.docker.compose.service=${svc}" --filter "health=healthy" --format "{{.Names}}" | wc -l)

            if [ "$RUNNING" -gt 0 ]; then
              echo "  âœ… $svc: $RUNNING running, $HEALTHY healthy"
            else
              echo "  âŒ $svc: NOT running"
              exit 1
            fi
          done

          # Test endpoints
          echo ""
          echo "ðŸ” Testing endpoints..."

          for i in {1..20}; do
            HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" https://docs.plus/ 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  âœ… https://docs.plus/ â†’ $HTTP_CODE"
              break
            fi
            [ $i -eq 20 ] && echo "  âš ï¸ https://docs.plus/ â†’ $HTTP_CODE (may still be provisioning)"
            sleep 3
          done

          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" https://prodback.docs.plus/api/health 2>/dev/null || echo "000")
          [ "$HTTP_CODE" = "200" ] && echo "  âœ… API health â†’ $HTTP_CODE" || echo "  âš ï¸ API health â†’ $HTTP_CODE"

          echo ""
          echo "âœ… Deployment verified"

      - name: ðŸ”„ Sync Production Directory
        run: |
          cd /opt/projects/prod.docs.plus/app/docs.plus/docs.plus
          docker compose -f ${{ env.COMPOSE_FILE }} --env-file ${{ env.ENV_FILE }} up -d \
            rest-api hocuspocus-server hocuspocus-worker webapp admin-dashboard
          echo "âœ… Production directory synced"

      - name: ðŸ§¹ Cleanup
        continue-on-error: true # Cleanup failure shouldn't fail deployment
        run: |
          docker image prune -f
          docker image prune -f --filter "until=24h" 2>/dev/null || true
          echo "âœ… Cleanup complete"

      - name: ðŸ“Š Summary
        run: |
          echo "======================================"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "======================================"
          echo "Tag: ${{ env.DEPLOY_TAG }}"
          echo ""
          echo "Services:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(traefik|docsplus|webapp|rest-api|hocuspocus)" | head -15
          echo ""
          echo "URLs:"
          echo "  - https://docs.plus"
          echo "  - https://prodback.docs.plus"
          echo "======================================"

      - name: ðŸš¨ Rollback on Failure
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed - attempting recovery..."

          cd /opt/projects/prod.docs.plus/app/docs.plus/docs.plus
          docker compose -f ${{ env.COMPOSE_FILE }} --env-file ${{ env.ENV_FILE }} \
            up -d --no-recreate 2>/dev/null || true

          echo "ðŸ“Š Current state:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | head -15

  # ============================================================================
  # UPTIME KUMA (Optional monitoring service)
  # ============================================================================
  deploy-uptime-kuma:
    name: ðŸ”” Deploy Uptime Kuma
    runs-on: prod.docs.plus
    timeout-minutes: 10
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      contains(github.event.head_commit.message, 'build') &&
      contains(github.event.head_commit.message, 'uptime-kuma')

    steps:
      - name: ðŸš€ Deploy
        run: |
          docker network create docsplus-network 2>/dev/null || true

          docker stop uptime-kuma 2>/dev/null || true
          docker rm uptime-kuma 2>/dev/null || true

          docker run -d \
            --name uptime-kuma \
            --network docsplus-network \
            --restart unless-stopped \
            -v uptime-kuma-data:/app/data \
            --label "traefik.enable=true" \
            --label "traefik.http.routers.uptime.rule=Host(\`status.docs.plus\`)" \
            --label "traefik.http.routers.uptime.entrypoints=websecure" \
            --label "traefik.http.routers.uptime.tls.certresolver=letsencrypt" \
            --label "traefik.http.services.uptime.loadbalancer.server.port=3001" \
            louislam/uptime-kuma:latest

          sleep 15
          echo "âœ… Uptime Kuma deployed at https://status.docs.plus"
