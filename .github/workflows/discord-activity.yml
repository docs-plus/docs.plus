name: "Discord: repo activity"

on:
 push:
  branches: ["**"]

jobs:
 notify:
  runs-on: ubuntu-latest
  steps:
   - name: Build commit summary (for push)
     id: build
     run: |
      EVENT='${{ toJSON(github.event) }}'
      COUNT=$(jq -r '.commits | length' <<< "$EVENT")
      REF=$(jq -r '.ref' <<< "$EVENT" | sed 's|refs/heads/||')
      COMPARE=$(jq -r '.compare' <<< "$EVENT")

      # List every commit with numbered list and clickable commit hash
      REPO_URL="https://github.com/${{ github.repository }}"
      COMMITS=$(jq -r --arg repo "$REPO_URL" '.commits | to_entries[] |
        (1 + .key | tostring) + ". " +
        (.value.message | gsub("\\r?\\n"; " ")) +
        " [" + .value.id[0:7] + "](" + $repo + "/commit/" + .value.id + ") by " + .value.author.name + "\n"' <<< "$EVENT")

      {
        echo "COUNT=$COUNT"
        echo "REF=$REF"
        echo "COMPARE=$COMPARE"
        echo 'COMMITS<<EOF'
        echo "$COMMITS"
        echo 'EOF'
      } >> "$GITHUB_ENV"

   - name: Post to Discord (with full commit list)
     uses: Ilshidur/action-discord@0.4.0
     env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
     with:
      args: |
       ğŸš€ **Push Event**
       ğŸ“¦ Repository: `${{ github.repository }}`
       ğŸ‘¤ Author: `${{ github.actor }}`
       ğŸŒ¿ Branch: `${{ env.REF }}`
       ğŸ“ Commits: `${{ env.COUNT }}`

       **Commit List:**
       ${{ env.COMMITS }}

       ğŸ”— [View Diff](${{ env.COMPARE }})
