name: "Discord: repo activity"

on:
 push:
  branches: ["**"]

jobs:
 notify:
  runs-on: ubuntu-latest
  steps:
   - name: Build commit summary (for push)
     id: build
     run: |
      EVENT='${{ toJSON(github.event) }}'
      COUNT=$(jq -r '.commits | length' <<< "$EVENT")
      REF=$(jq -r '.ref' <<< "$EVENT")
      COMPARE=$(jq -r '.compare' <<< "$EVENT")

      # List every commit (one line per commit)
      COMMITS=$(jq -r '.commits[]
        | "- " + (.message | gsub("\\r?\\n"; " "))
        + " (" + .id[0:7] + ") by " + .author.name' <<< "$EVENT")

      {
        echo "COUNT=$COUNT"
        echo "REF=$REF"
        echo "COMPARE=$COMPARE"
        echo 'COMMITS<<EOF'
        echo "$COMMITS"
        echo 'EOF'
      } >> "$GITHUB_ENV"

   - name: Post to Discord (with full commit list)
     uses: Ilshidur/action-discord@0.4.0
     env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
     with:
      args: >
       [${{ github.repository }}] push by ${{ github.actor }}
       • Ref: ${{ env.REF }}
       • ${{ env.COUNT }} commit(s):
       ${{ env.COMMITS }}
       • Diff: ${{ env.COMPARE }}
