# ============================================================================
# Staging CI/CD Pipeline - Unified Quality Gates + Deployment
# ============================================================================
#
# Pipeline Stages:
#   1. Quality Gates (parallel): lint, typecheck, security
#   2. Build Verification: extensions + apps
#   3. Deploy: Docker build + deployment to staging
#
# Triggers:
#   - Push to dev: Full pipeline (deploy requires 'build' in commit)
#   - Pull request to dev: Quality gates + build only
#
# ============================================================================

name: CI/CD Staging

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:
    inputs:
      skip_quality_gates:
        description: 'Skip quality gates (emergency deploy)'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment (bypass commit message check)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege - only request needed permissions
permissions:
  contents: read
  actions: read

env:
  ENV_SOURCE: /opt/projects/stage.docs.plus/.env
  ENV_FILE: .env.staging
  COMPOSE_FILE: docker-compose.prod.yml
  DEPLOY_TAG: ${{ github.sha }}

# ============================================================================
# STAGE 1: QUALITY GATES (parallel, fast feedback)
# ============================================================================
jobs:
  lint:
    name: üîç Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Environment
        uses: ./.github/actions/setup-bun

      - name: üîç ESLint
        run: bun run lint

      - name: üé® Prettier Check
        run: bun run format:check

  typecheck:
    name: üìù Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Environment
        uses: ./.github/actions/setup-bun

      - name: üîß Build Extensions (required for types)
        run: |
          bun run --filter @docs.plus/extension-hyperlink build
          bun run --filter @docs.plus/extension-hypermultimedia build
          bun run --filter @docs.plus/extension-indent build
          bun run --filter @docs.plus/extension-inline-code build

      - name: üìù Type Check All
        run: bun run check:types

  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Environment
        uses: ./.github/actions/setup-bun
        with:
          ignore-scripts: 'true'

      - name: üîç Bun Audit
        run: |
          echo "üîç Checking for vulnerabilities..."
          bun pm audit 2>&1 | tee audit-results.txt || true

          CRITICAL=$(grep -ci "critical" audit-results.txt 2>/dev/null || echo "0")
          HIGH=$(grep -ci "high" audit-results.txt 2>/dev/null || echo "0")

          echo "üìä Summary: Critical=$CRITICAL, High=$HIGH"

          # Warning only on staging (don't block)
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ö†Ô∏è Vulnerabilities found (warning only on staging)"
          fi
          echo "‚úÖ Security check complete"

  # ============================================================================
  # STAGE 2: BUILD VERIFICATION
  # ============================================================================
  build:
    name: üèóÔ∏è Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, typecheck, security]
    if: |
      always() &&
      (needs.lint.result == 'success' || inputs.skip_quality_gates == true) &&
      (needs.typecheck.result == 'success' || inputs.skip_quality_gates == true) &&
      (needs.security.result == 'success' || needs.security.result == 'skipped' || inputs.skip_quality_gates == true)

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: ü•ü Setup Environment
        uses: ./.github/actions/setup-bun

      - name: üîß Build TipTap Extensions
        run: |
          bun run --filter @docs.plus/extension-hyperlink build
          bun run --filter @docs.plus/extension-hypermultimedia build
          bun run --filter @docs.plus/extension-indent build
          bun run --filter @docs.plus/extension-inline-code build

      - name: üèóÔ∏è Build Webapp
        run: bun run --filter @docs.plus/webapp build:ci
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'http://localhost:54321' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}

      - name: üèóÔ∏è Build Admin Dashboard
        run: bun run --filter @docs.plus/admin-dashboard build:ci
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'http://localhost:54321' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3003' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}

  # ============================================================================
  # STAGE 3: STAGING DEPLOYMENT
  # ============================================================================
  deploy:
    name: üé® Deploy Staging
    runs-on: stage.docs.plus
    timeout-minutes: 30
    needs: [build]
    if: |
      github.ref == 'refs/heads/dev' &&
      github.event_name == 'push' &&
      needs.build.result == 'success' &&
      (
        (contains(github.event.head_commit.message, 'build') &&
         (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back')))
        || github.event.inputs.force_deploy == 'true'
      )
    environment:
      name: staging
      url: https://stage.docs.plus

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì• Install Dependencies
        run: bun install --frozen-lockfile

      - name: üîê Prepare Environment
        run: |
          if [ ! -f "${{ env.ENV_SOURCE }}" ]; then
            echo "‚ùå .env file not found at ${{ env.ENV_SOURCE }}"
            exit 1
          fi
          cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"
          echo "DEPLOY_TAG=${{ env.DEPLOY_TAG }}" >> "${{ env.ENV_FILE }}"
          echo "‚úÖ Environment prepared"

      - name: üèóÔ∏è Build Docker Images
        run: |
          set -a
          source ${{ env.ENV_FILE }}
          set +a

          docker compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            build --parallel

      - name: üöÄ Deploy Services
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            up -d \
            --remove-orphans \
            --scale webapp=1 \
            --scale rest-api=1 \
            --scale hocuspocus-server=1 \
            --scale hocuspocus-worker=1 \
            --scale admin-dashboard=1

      - name: ‚è≥ Wait for Services
        run: sleep 20

      - name: ü©∫ Health Checks
        run: |
          echo "üìä Infrastructure:"
          for svc in traefik docsplus-redis; do
            docker ps --filter "name=$svc" | grep -q "$svc" && echo "  ‚úÖ $svc running" || echo "  ‚ö†Ô∏è $svc not found"
          done

          echo "üìä Services:"
          for svc in webapp rest-api hocuspocus-server hocuspocus-worker admin-dashboard; do
            COUNT=$(docker ps --filter "name=${svc}" --format "{{.Names}}" | wc -l)
            echo "  ‚úÖ $svc: $COUNT container(s)"
          done

      - name: üßπ Cleanup
        continue-on-error: true # Cleanup failure shouldn't fail deployment
        run: |
          docker image prune -f
          echo "‚úÖ Cleanup complete"

      - name: üìä Summary
        run: |
          echo "======================================"
          echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL"
          echo "======================================"
          echo "Tag: ${{ env.DEPLOY_TAG }}"
          echo ""
          docker ps --format "table {{.Names}}\t{{.Status}}" | head -15
          echo "======================================"
