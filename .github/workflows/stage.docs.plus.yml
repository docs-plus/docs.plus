# ============================================================================
# Staging CI/CD Pipeline - Traefik Deployment
# ============================================================================

name: CI-Staging

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

env:
  ENV_SOURCE: /opt/projects/stage.docs.plus/.env
  ENV_FILE: .env.staging
  COMPOSE_FILE: docker-compose.prod.yml
  DEPLOY_TAG: ${{ github.sha }}

jobs:
  deploy:
    name: üé® Deploy to Staging
    runs-on: stage.docs.plus
    if: contains(github.event.head_commit.message, 'build') && (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back'))

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì• Install Dependencies
        run: bun install --frozen-lockfile

      - name: üîê Prepare Environment
        run: |
          if [ ! -f "${{ env.ENV_SOURCE }}" ]; then
            echo "‚ùå .env file not found at ${{ env.ENV_SOURCE }}"
            exit 1
          fi
          cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"
          echo "DEPLOY_TAG=${{ env.DEPLOY_TAG }}" >> "${{ env.ENV_FILE }}"
          echo "‚úÖ Environment prepared"

      - name: üèóÔ∏è Build Docker Images
        run: |
          set -a
          source ${{ env.ENV_FILE }}
          set +a

          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            build --parallel

      - name: üöÄ Deploy Services
        run: |
          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            up -d \
            --remove-orphans \
            --scale webapp=1 \
            --scale rest-api=1 \
            --scale hocuspocus-server=1 \
            --scale hocuspocus-worker=1

      - name: ‚è≥ Wait for Services
        run: sleep 20

      - name: ü©∫ Health Checks
        run: |
          for svc in traefik docsplus-redis; do
            docker ps --filter "name=$svc" | grep -q "$svc" && echo "‚úÖ $svc running" || echo "‚ö†Ô∏è $svc not found"
          done

          for svc in webapp rest-api hocuspocus-server hocuspocus-worker; do
            COUNT=$(docker ps --filter "name=${svc}" --format "{{.Names}}" | wc -l)
            echo "‚úÖ $svc: $COUNT container(s)"
          done

      - name: üìä Summary
        run: |
          echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL"
          docker ps --format "table {{.Names}}\t{{.Status}}" | head -15
