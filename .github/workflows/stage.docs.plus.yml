# ============================================================================
# Staging CI/CD Pipeline - Docker Compose Deployment
# ============================================================================
#
# DIRECTORY STRUCTURE ON SERVER:
# /opt/projects/stage.docs.plus/
# â”œâ”€â”€ .env                              â† Main environment file
# â””â”€â”€ app/docs.plus/docs.plus/          â† Git repo (GitHub Actions workspace)
#
# ============================================================================

name: CI-Staging

on:
 push:
  branches: [dev]
 pull_request:
  branches: [dev]

env:
 # .env location (3 levels up from app directory)
 ENV_SOURCE: /opt/projects/stage.docs.plus/.env
 ENV_FILE: .env.staging
 # Docker settings
 COMPOSE_FILE: docker-compose.prod.yml
 DOCKER_NETWORK: stage-docsplus-network
 FRONTEND_PORT: 3000

jobs:
 deploy-stack:
  name: ðŸŽ¨ Deploy Staging Stack
  runs-on: stage.docs.plus
  if: contains(github.event.head_commit.message, 'build') && (contains(github.event.head_commit.message, 'front') || contains(github.event.head_commit.message, 'back'))

  steps:
   - name: ðŸ“¦ Checkout Code
     uses: actions/checkout@v4
     with:
      fetch-depth: 1
      clean: false

   - name: ðŸ¥Ÿ Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: latest

   - name: ðŸ“¥ Install Dependencies
     run: bun install --frozen-lockfile

   - name: ðŸ” Prepare Environment
     run: |
      if [ ! -f "${{ env.ENV_SOURCE }}" ]; then
        echo "âŒ .env file not found at ${{ env.ENV_SOURCE }}"
        exit 1
      fi

      cp "${{ env.ENV_SOURCE }}" "${{ env.ENV_FILE }}"

      if ! grep -q "DATABASE_URL" "${{ env.ENV_FILE }}"; then
        echo "âŒ DATABASE_URL not found in .env file"
        exit 1
      fi

      echo "âœ… Environment prepared"

   - name: ðŸ” Ensure Redis
     run: |
      docker network create ${{ env.DOCKER_NETWORK }} 2>/dev/null || true

      if ! docker ps | grep -q "stage-docsplus-redis"; then
        docker run -d \
          --name stage-docsplus-redis \
          --network ${{ env.DOCKER_NETWORK }} \
          --restart unless-stopped \
          -p 6379:6379 \
          -v stage-redis-data:/data \
          redis:alpine \
          redis-server --appendonly yes --maxmemory 1gb --maxmemory-policy noeviction
        sleep 5
      fi

      docker exec stage-docsplus-redis redis-cli ping | grep -q PONG && echo "âœ… Redis healthy"

   - name: ðŸ›‘ Stop Current Stack
     run: |
      docker-compose -f ${{ env.COMPOSE_FILE }} \
        --env-file ${{ env.ENV_FILE }} \
        -p stage-docsplus \
        down || true

      - name: ðŸ—ï¸ Build Docker Images
        run: |
          # Extract DATABASE_URL from env file for Prisma generate during build
          export DATABASE_URL=$(grep "^DATABASE_URL=" ${{ env.ENV_FILE }} | cut -d'=' -f2-)

          docker-compose -f ${{ env.COMPOSE_FILE }} \
            --env-file ${{ env.ENV_FILE }} \
            -p stage-docsplus \
            build \
            --build-arg DATABASE_URL="${DATABASE_URL}"

   - name: ðŸš€ Deploy Stack
     run: |
      sed -i "s/NGINX_HTTP_PORT=.*/NGINX_HTTP_PORT=${{ env.FRONTEND_PORT }}/" ${{ env.ENV_FILE }}

      docker-compose -f ${{ env.COMPOSE_FILE }} \
        --env-file ${{ env.ENV_FILE }} \
        -p stage-docsplus \
        up -d \
        --scale webapp=1 \
        --scale rest-api=1 \
        --scale hocuspocus-server=1 \
        --scale hocuspocus-worker=1

   - name: â³ Wait for Services
     run: sleep 20

   - name: ðŸ©º Health Checks
     run: |
      WEBAPP=$(docker ps --filter "name=stage-docsplus-webapp" --format "{{.Names}}" | head -1)
      docker exec $WEBAPP bun -e "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "âœ… Frontend healthy"

      REST=$(docker ps --filter "name=stage-docsplus-rest-api" --format "{{.Names}}" | head -1)
      docker exec $REST bun -e "fetch('http://localhost:4000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "âœ… REST API healthy"

      WS=$(docker ps --filter "name=stage-docsplus-hocuspocus-server" --format "{{.Names}}" | head -1)
      docker exec $WS bun -e "fetch('http://localhost:4001/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "âœ… WebSocket healthy"

      WORKER=$(docker ps --filter "name=stage-docsplus-hocuspocus-worker" --format "{{.Names}}" | head -1)
      docker exec $WORKER bun -e "fetch('http://localhost:4002/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" && echo "âœ… Worker healthy"

   - name: ðŸ“Š Summary
     run: |
      echo "âœ… STAGING DEPLOYMENT SUCCESSFUL"
      docker ps --filter "name=stage-docsplus-" --format "table {{.Names}}\t{{.Status}}"
