# ============================================================================
# Composite Action: Setup Bun Environment
# ============================================================================
# Reusable Bun setup with caching. Key invalidates on bun.lock changes.
# Increment cache-version to manually bust cache when needed.
# ============================================================================

name: 'Setup Bun Environment'
description: 'Setup Bun with cached dependencies'

inputs:
  bun-version:
    description: 'Bun version'
    default: 'latest'
  ignore-scripts:
    description: 'Skip postinstall scripts (for security job)'
    default: 'false'
  cache-version:
    description: 'Increment to bust cache (v1, v2, etc)'
    default: 'v1'

outputs:
  cache-hit:
    description: 'Whether cache was hit'
    value: ${{ steps.cache.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ¥Ÿ Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ inputs.bun-version }}

    - name: ðŸ“¦ Cache Dependencies
      id: cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-bun-${{ inputs.cache-version }}-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-${{ inputs.cache-version }}-
          ${{ runner.os }}-bun-

    - name: ðŸ“¥ Install Dependencies
      shell: bash
      run: |
        [ "${{ steps.cache.outputs.cache-hit }}" = "true" ] && echo "âœ… Cache HIT" || echo "ðŸ“¦ Installing..."
        bun install --frozen-lockfile ${{ inputs.ignore-scripts == 'true' && '--ignore-scripts' || '' }}
