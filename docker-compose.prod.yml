# =============================================================================
# Root Docker Compose - Full Stack Production
#
# ENVIRONMENT VARIABLES:
# Production environment variables are loaded from .env.production file
# Use --env-file flag to specify the environment file
#
# USAGE:
#   docker-compose -f docker-compose.prod.yml --env-file .env.production up
#   docker-compose -f docker-compose.prod.yml --env-file .env.production up --build
# =============================================================================

services:
 # ===========================================================================
 # INFRASTRUCTURE - Shared Services
 # ===========================================================================

 # ---------------------------------------------------------------------------
 # PostgreSQL Database (Shared by Hocuspocus)
 # ---------------------------------------------------------------------------
 postgres:
  image: postgres:17-alpine
  container_name: docsy-postgres
  restart: unless-stopped
  environment:
   POSTGRES_DB: docsplus
   POSTGRES_USER: ${DB_USER:-docsplus}
   POSTGRES_PASSWORD: ${DB_PASSWORD:-CHANGE_ME_STRONG_PASSWORD}
   POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
  ports:
   - "${DB_PORT:-5432}:5432"
  volumes:
   - postgres_data:/var/lib/postgresql/data
  healthcheck:
   test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-docsplus}"]
   interval: 10s
   timeout: 5s
   retries: 5
   start_period: 10s
  networks:
   - docsy-network
  deploy:
   resources:
    limits:
     cpus: "2"
     memory: 2G
    reservations:
     cpus: "1"
     memory: 512M

 # ---------------------------------------------------------------------------
 # Redis Cache & Pub/Sub (Shared by Hocuspocus)
 # ---------------------------------------------------------------------------
 # Using "noeviction" (not "allkeys-lru") to prevent silent data loss in collaboration/pub-sub
 redis:
  image: redis:alpine
  container_name: docsy-redis
  restart: unless-stopped
  command: redis-server --appendonly yes --maxmemory 1gb --maxmemory-policy noeviction --tcp-backlog 511 --timeout 300 --tcp-keepalive 300
  ports:
   - "${REDIS_PORT:-6379}:6379"
  volumes:
   - redis_data:/data
  healthcheck:
   test: ["CMD", "redis-cli", "ping"]
   interval: 10s
   timeout: 5s
   retries: 5
   start_period: 5s
  networks:
   - docsy-network
  deploy:
   resources:
    limits:
     cpus: "2"
     memory: 2G
    reservations:
     cpus: "0.5"
     memory: 512M

 # ===========================================================================
 # HOCUSPOCUS SERVER SERVICES
 # ===========================================================================

 # ---------------------------------------------------------------------------
 # REST API Service (Scalable)
 # ---------------------------------------------------------------------------
 rest-api:
  image: docsy-hocuspocus:latest
  build:
   context: ./packages/hocuspocus.server
   dockerfile: docker/Dockerfile.bun
   target: production
   args:
    DATABASE_URL: ${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}
  restart: unless-stopped
  command: bun /app/src/index.ts
  # All environment variables loaded from .env.production file
  environment:
   NODE_ENV: production
   APP_PORT: 4000
   DATABASE_URL: postgresql://${DB_USER:-docsplus}:${DB_PASSWORD:-CHANGE_ME_STRONG_PASSWORD}@postgres:5432/docsplus?connection_limit=20&pool_timeout=10&sslmode=prefer
   REDIS: true
   REDIS_HOST: redis
   REDIS_PORT: 6379
   JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-replace-this-in-production}
   SUPABASE_URL: ${SUPABASE_URL}
   SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
   LOG_LEVEL: ${LOG_LEVEL:-error}
   REST_LOG_LEVEL: ${REST_LOG_LEVEL:-info}
   ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}
   RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-500}
   HOCUSPOCUS_LOGGER: false
   HOCUSPOCUS_THROTTLE: true
   DO_STORAGE_ENDPOINT: ${DO_STORAGE_ENDPOINT}
   DO_STORAGE_REGION: ${DO_STORAGE_REGION}
   DO_STORAGE_BUCKET: ${DO_STORAGE_BUCKET}
   DO_STORAGE_ACCESS_KEY_ID: ${DO_STORAGE_ACCESS_KEY_ID}
   DO_STORAGE_SECRET_ACCESS_KEY: ${DO_STORAGE_SECRET_ACCESS_KEY}
  # Ports not exposed - accessed via nginx reverse proxy
  # Multiple replicas can't bind to same host port
  expose:
   - "4000"
  depends_on:
   postgres:
    condition: service_healthy
   redis:
    condition: service_healthy
  healthcheck:
   test:
    [
     "CMD",
     "bun",
     "-e",
     "fetch('http://localhost:4000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
    ]
   interval: 30s
   timeout: 5s
   retries: 3
   start_period: 30s
  networks:
   - docsy-network
  deploy:
   replicas: ${REST_REPLICAS:-2}
   resources:
    limits:
     cpus: "1"
     memory: 1G
    reservations:
     cpus: "0.25"
     memory: 256M
   restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3

 # ---------------------------------------------------------------------------
 # Hocuspocus WebSocket Server (Scalable)
 # ---------------------------------------------------------------------------
 hocuspocus-server:
  image: docsy-hocuspocus:latest
  build:
   context: ./packages/hocuspocus.server
   dockerfile: docker/Dockerfile.bun
   target: production
   args:
    DATABASE_URL: ${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}
  restart: unless-stopped
  command: bun /app/src/hocuspocus.server.ts
  # All environment variables loaded from .env.production file
  environment:
   NODE_ENV: production
   HOCUSPOCUS_PORT: 4001
   DATABASE_URL: postgresql://${DB_USER:-docsplus}:${DB_PASSWORD:-CHANGE_ME_STRONG_PASSWORD}@postgres:5432/docsplus?connection_limit=20&pool_timeout=10&sslmode=prefer
   REDIS: true
   REDIS_HOST: redis
   REDIS_PORT: 6379
   JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-replace-this-in-production}
   SUPABASE_URL: ${SUPABASE_URL}
   SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
   LOG_LEVEL: ${LOG_LEVEL:-error}
   WS_LOG_LEVEL: ${WS_LOG_LEVEL:-info}
   HOCUSPOCUS_LOGGER: false
   HOCUSPOCUS_THROTTLE: true
   HOCUSPOCUS_THROTTLE_ATTEMPTS: ${HOCUSPOCUS_THROTTLE_ATTEMPTS:-10}
   HOCUSPOCUS_THROTTLE_BANTIME: ${HOCUSPOCUS_THROTTLE_BANTIME:-60000}
  # Ports not exposed - accessed via nginx reverse proxy
  # Multiple replicas can't bind to same host port
  expose:
   - "4001"
  depends_on:
   postgres:
    condition: service_healthy
   redis:
    condition: service_healthy
  healthcheck:
   test:
    [
     "CMD",
     "bun",
     "-e",
     "fetch('http://localhost:4001/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
    ]
   interval: 30s
   timeout: 5s
   retries: 3
   start_period: 30s
  networks:
   - docsy-network
  deploy:
   replicas: ${WS_REPLICAS:-3}
   resources:
    limits:
     cpus: "1"
     memory: 1G
    reservations:
     cpus: "0.5"
     memory: 512M
   restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3

 # ---------------------------------------------------------------------------
 # Hocuspocus Worker (Scalable)
 # ---------------------------------------------------------------------------
 hocuspocus-worker:
  image: docsy-hocuspocus:latest
  build:
   context: ./packages/hocuspocus.server
   dockerfile: docker/Dockerfile.bun
   target: production
   args:
    DATABASE_URL: ${DATABASE_URL:-postgresql://dummy:dummy@localhost:5432/dummy}
  restart: unless-stopped
  command: bun /app/src/hocuspocus.worker.ts
  # All environment variables loaded from .env.production file
  environment:
   NODE_ENV: production
   WORKER_HEALTH_PORT: 4002
   DATABASE_URL: postgresql://${DB_USER:-docsplus}:${DB_PASSWORD:-CHANGE_ME_STRONG_PASSWORD}@postgres:5432/docsplus?connection_limit=20&pool_timeout=10&sslmode=prefer
   REDIS: true
   REDIS_HOST: redis
   REDIS_PORT: 6379
   REDIS_CONNECT_TIMEOUT: ${REDIS_CONNECT_TIMEOUT:-30000}
   REDIS_COMMAND_TIMEOUT: ${REDIS_COMMAND_TIMEOUT:-60000}
   REDIS_KEEPALIVE: ${REDIS_KEEPALIVE:-30000}
   REDIS_MAX_RETRIES: ${REDIS_MAX_RETRIES:-10}
   LOG_LEVEL: ${LOG_LEVEL:-error}
   WORKER_LOG_LEVEL: ${WORKER_LOG_LEVEL:-info}
   BULLMQ_CONCURRENCY: ${BULLMQ_CONCURRENCY:-20}
   BULLMQ_RATE_LIMIT_MAX: ${BULLMQ_RATE_LIMIT_MAX:-1000}
   BULLMQ_RATE_LIMIT_DURATION: ${BULLMQ_RATE_LIMIT_DURATION:-1000}
   DO_STORAGE_ENDPOINT: ${DO_STORAGE_ENDPOINT}
   DO_STORAGE_REGION: ${DO_STORAGE_REGION}
   DO_STORAGE_BUCKET: ${DO_STORAGE_BUCKET}
   DO_STORAGE_ACCESS_KEY_ID: ${DO_STORAGE_ACCESS_KEY_ID}
   DO_STORAGE_SECRET_ACCESS_KEY: ${DO_STORAGE_SECRET_ACCESS_KEY}
  # Ports not exposed - accessed via nginx reverse proxy
  # Multiple replicas can't bind to same host port
  expose:
   - "4002"
  depends_on:
   postgres:
    condition: service_healthy
   redis:
    condition: service_healthy
  healthcheck:
   test:
    [
     "CMD",
     "bun",
     "-e",
     "fetch('http://localhost:4002/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
    ]
   interval: 30s
   timeout: 5s
   retries: 3
   start_period: 30s
  networks:
   - docsy-network
  deploy:
   replicas: ${WORKER_REPLICAS:-2}
   resources:
    limits:
     cpus: "2"
     memory: 2G
    reservations:
     cpus: "0.5"
     memory: 512M
   restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3

 # ===========================================================================
 # WEBAPP SERVICES
 # ===========================================================================

 # ---------------------------------------------------------------------------
 # Next.js Webapp (Scalable)
 # ---------------------------------------------------------------------------
 webapp:
  build:
   context: .
   dockerfile: packages/webapp/docker/Dockerfile.bun
   args:
    BUILDKIT_INLINE_CACHE: 1
    BUILD_ID: ${BUILD_ID:-production-build}
    GIT_HASH: ${GIT_HASH:-latest}
    NODE_ENV: production
    NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
    NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    NEXT_PUBLIC_PROVIDER_URL: ${NEXT_PUBLIC_PROVIDER_URL}
    NEXT_PUBLIC_RESTAPI_URL: ${NEXT_PUBLIC_RESTAPI_URL}
    NEXT_PUBLIC_SSE_URL: ${NEXT_PUBLIC_SSE_URL}
    NEXT_PUBLIC_GA_ID: ${NEXT_PUBLIC_GA_ID}
  image: docsy-webapp:latest
  # DO NOT add container_name - it breaks horizontal scaling
  expose:
   - "3000"
  environment:
   NODE_ENV: production
   PORT: 3000
   HOSTNAME: "0.0.0.0"
   NEXT_TELEMETRY_DISABLED: 1
   # Webapp environment variables loaded from .env.production
   NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
   NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
   NEXT_PUBLIC_PROVIDER_URL: ${NEXT_PUBLIC_PROVIDER_URL:-ws://localhost:3000}
   NEXT_PUBLIC_RESTAPI_URL: ${NEXT_PUBLIC_RESTAPI_URL:-http://rest-api:4000}
   NEXT_PUBLIC_SSE_URL: ${NEXT_PUBLIC_SSE_URL:-http://localhost:3000/sse}
   NEXT_PUBLIC_GA_ID: ${NEXT_PUBLIC_GA_ID:-}
   # Server-side URLs (internal Docker network)
   SERVER_RESTAPI_URL: ${SERVER_RESTAPI_URL:-http://rest-api:4000/api}
  restart: unless-stopped
  networks:
   - docsy-network
  depends_on:
   rest-api:
    condition: service_healthy
   hocuspocus-server:
    condition: service_healthy
  healthcheck:
   test:
    [
     "CMD",
     "bun",
     "-e",
     "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
    ]
   interval: 30s
   timeout: 3s
   start_period: 10s
   retries: 3
  deploy:
   replicas: ${WEBAPP_REPLICAS:-2}
   resources:
    limits:
     cpus: "2"
     memory: 1G
    reservations:
     cpus: "0.5"
     memory: 256M
   restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
  logging:
   driver: "json-file"
   options:
    max-size: "10m"
    max-file: "3"
  labels:
   - "com.docker.compose.project=docsy"
   - "com.docker.compose.service=webapp"

 # ---------------------------------------------------------------------------
 # Nginx Reverse Proxy
 # ---------------------------------------------------------------------------
 nginx:
  image: nginx:alpine
  container_name: docsy-nginx
  ports:
   - "${NGINX_HTTP_PORT:-3000}:80"
   - "${NGINX_HTTPS_PORT:-443}:443"
  volumes:
   - ./packages/webapp/docker/nginx.conf:/etc/nginx/nginx.conf:ro
   - ./packages/webapp/docker/ssl:/etc/nginx/ssl:ro
  depends_on:
   webapp:
    condition: service_healthy
  networks:
   - docsy-network
  restart: unless-stopped
  deploy:
   resources:
    limits:
     cpus: "1"
     memory: 256M
    reservations:
     cpus: "0.25"
     memory: 128M
  healthcheck:
   test:
    [
     "CMD",
     "wget",
     "--quiet",
     "--tries=1",
     "--spider",
     "http://localhost/health",
    ]
   interval: 30s
   timeout: 3s
   retries: 3
  logging:
   driver: "json-file"
   options:
    max-size: "10m"
    max-file: "3"

# =============================================================================
# Volumes
# =============================================================================
volumes:
 postgres_data:
  driver: local
  name: docsy-postgres-prod
 redis_data:
  driver: local
  name: docsy-redis-prod

# =============================================================================
# Networks
# =============================================================================
networks:
 docsy-network:
  driver: bridge
  name: docsy-network
