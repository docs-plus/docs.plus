generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  owner
  collaborator
}

model Documents {
  id            Int              @id @default(autoincrement())
  documentId    String
  version       Int              @default(1)
  commitMessage String?
  data          Bytes
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  metadata      DocumentMetadata @relation(fields: [documentId], references: [documentId], onDelete: Cascade)
  collaborators DocumentUsers[]

  @@unique([documentId, version], name: "Documents_documentId_version_unique")
  @@index([documentId]) // Dedicated index for fetch queries
  @@index([documentId, version]) // Composite for version queries
  @@index([createdAt])
}

model DocumentMetadata {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String?
  description String?
  keywords    String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  documentId  String   @unique
  readOnly    Boolean  @default(false)
  ownerId     String?
  email       String?

  documents Documents[]

  @@index([ownerId])
}

model DocumentUsers {
  documentPk Int
  userId     String
  role       Role?     @default(collaborator)
  email      String?
  document   Documents @relation(fields: [documentPk], references: [id], onDelete: Cascade)

  @@id([documentPk, userId])
  @@index([userId])
}

// ============================================================================
// Idempotency Tables
// Prevent duplicate sends on worker retries
// ============================================================================

model EmailSentLog {
  id             String   @id @default(cuid())
  idempotencyKey String   @unique // email:{jobId}
  messageId      String? // SMTP/provider message ID
  recipient      String
  emailType      String? // notification type
  sentAt         DateTime @default(now())
  expiresAt      DateTime @default(dbgenerated("NOW() + INTERVAL '7 days'"))

  @@index([expiresAt])
  @@index([recipient, sentAt])
}

model PushSentLog {
  id                String   @id @default(cuid())
  idempotencyKey    String   @unique // push:{jobId}
  userId            String
  subscriptionCount Int      @default(0) // How many devices received
  sentAt            DateTime @default(now())
  expiresAt         DateTime @default(dbgenerated("NOW() + INTERVAL '7 days'"))

  @@index([expiresAt])
  @@index([userId, sentAt])
}
