# Build Stage
FROM node:alpine3.17 as builder

ENV NODE_ENV=production

# for Node-gyp and dependencies
RUN apk add --no-cache python3 make g++ && \
  mkdir -p /app && \
  chown -R node:node /app

USER node

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm install && npx prisma generate

# Runtime Stage
FROM node:alpine3.17

ARG ENVIRONMENT=stage

ENV ENVIRONMENT=$ENVIRONMENT

WORKDIR /app

COPY --from=builder /app .
COPY . .

RUN npm install pm2 -g

CMD pm2-runtime pm2.config.cjs --only ${ENVIRONMENT}_rest,${ENVIRONMENT}_ws
